<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Admin Panel - Temizlik Bildirimleri</title>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1"
  >
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap"
    rel="stylesheet"
  >
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: #f6f8fb;
    }

    .card-soft {
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(20, 20, 40, 0.04);
    }

    .brand {
      color: #2b3a67;
      font-weight: 600;
    }

    .badge-issue {
      background: #6c8ef5;
      color: white;
      margin-right: 6px;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: .85rem;
    }

    .muted {
      color: #6b7280;
    }

    .btn-soft {
      background: linear-gradient(90deg, #7aa2ff, #6b8cf0);
      color: white;
      border: 0;
      box-shadow: none;
    }

    .small-card {
      font-size: .95rem;
      color: #334155;
    }

    .qr-thumb {
      width: 84px;
      height: 84px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e6eefc;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a
        class="navbar-brand brand"
        href="#"
      >Temizlik Bildirimleri</a>
      <div class="ms-auto d-flex gap-2">
        <form
          method="post"
          action="/admin/logout"
        >
          <button
            class="btn btn-outline-secondary btn-sm"
            type="submit"
          >Çıkış</button>
        </form>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div class="row g-4">
      <div class="col-12">
        <ul
          class="nav nav-tabs"
          id="tabs"
        >
          <li class="nav-item"><a
              class="nav-link active"
              data-bs-toggle="tab"
              href="#pane-feedback"
            >Gelen Bildirimler</a></li>
          <li class="nav-item"><a
              class="nav-link"
              data-bs-toggle="tab"
              href="#pane-locations"
            >Lokasyonlar</a></li>
        </ul>

        <div class="tab-content mt-3">
          <!-- Feedbacks -->
          <div
            class="tab-pane fade show active"
            id="pane-feedback"
          >
            <div id="listbox"></div>
          </div>

          <!-- Locations -->
          <div
            class="tab-pane fade"
            id="pane-locations"
          >
            <div class="card card-soft p-3 mb-3">
              <h6 class="mb-2">Yeni Lokasyon Ekle</h6>
              <form
                id="addLocationForm"
                class="row g-2 align-items-end"
              >
                <div class="col-12 col-md-3">
                  <label class="form-label small-muted">Kod (ör: L0003)</label>
                  <input
                    name="code"
                    class="form-control"
                  />
                </div>
                <div class="col-12 col-md-5">
                  <label class="form-label small-muted">Ad (örn: 3. Kat Bayan WC)</label>
                  <input
                    name="name"
                    class="form-control"
                  />
                </div>
                <div class="col-12 col-md-2">
                  <label class="form-label small-muted">Tip</label>
                  <select
                    name="type"
                    class="form-select"
                  >
                    <option value="toilet">Tuvalet</option>
                    <option value="room">Yataklı Oda</option>
                  </select>
                </div>
                <div class="col-12 col-md-2">
                  <button
                    type="button"
                    class="btn btn-soft w-100"
                    onclick="addLocation()"
                  >Ekle</button>
                </div>
              </form>
            </div>

            <div id="locationsList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function fetchList() {
      try {
        const r = await fetch('/api/unresolved');
        const items = await r.json();
        const cont = document.getElementById('listbox');
        if (!items || items.length === 0) {
          cont.innerHTML = '<div class="alert alert-success">Yeni bildirim yok.</div>';
          return;
        }
        let html = '';
        for (const it of items) {
          const issues = it.meta && it.meta.issues ? it.meta.issues : [];
          const note = it.meta && it.meta.note ? it.meta.note : '';
          let issueHtml = '';
          for (const iss of issues) {
            issueHtml += `<span class="badge-issue">${iss.label}</span>`;
          }
          html += `<div class="card mb-2 card-soft">
        <div class="card-body d-flex gap-3 align-items-start">
          <div style="flex:1">
            <h6 class="mb-1 small-card">${it.name} <small class="muted">(${it.code})</small></h6>
            <div class="mb-2">${issueHtml}</div>
            ${note ? `<div class="text-muted mb-2">Not: ${note}</div>` : ''}
            <div class="muted">Gönderim: ${it.reported_at}</div>
          </div>
          <div class="text-end">
            <button class="btn btn-success" onclick="resolve(${it.id})">Tamamlandı</button>
          </div>
        </div>
      </div>`;
        }
        cont.innerHTML = html;
      } catch (e) {
        document.getElementById('listbox').innerText = 'Liste alınamadı: ' + e;
      }
    }

    async function resolve(id) {
      const fd = new FormData();
      fd.append('feedback_id', id);
      await fetch('/admin/resolve', { method: 'POST', body: fd });
      fetchList();
    }

    /* ---------- Lokasyon işlemleri ---------- */
    async function fetchLocations() {
      try {
        const r = await fetch('/api/locations');
        const locs = await r.json();
        const cont = document.getElementById('locationsList');
        if (!locs || locs.length === 0) {
          cont.innerHTML = '<div class="alert alert-info">Henüz kayıtlı lokasyon yok.</div>';
          return;
        }
        let html = '<div class="row g-3">';
        for (const l of locs) {
          const qr = l.code ? `/static/qrcodes/${l.code}.png` : '';
          html += `<div class="col-12 col-md-6">
        <div class="card p-3 card-soft d-flex align-items-center">
          <div class="d-flex w-100 gap-3 align-items-center">
            <img src="${qr}" onerror="this.style.display=\'none\'" class="qr-thumb" alt="QR">
            <div style="flex:1">
              <div class="fw-semibold">${l.name}</div>
              <div class="muted">${l.code} • ${l.type}</div>
              <div class="muted small mt-1">Son durum: ${l.last_status || '—'}</div>
            </div>
            <div>
              <button class="btn btn-outline-danger btn-sm" onclick="deleteLocation('${l.code}')">Sil</button>
            </div>
          </div>
        </div>
      </div>`;
        }
        html += '</div>';
        cont.innerHTML = html;
      } catch (e) {
        document.getElementById('locationsList').innerText = 'Lokasyonlar alınamadı: ' + e;
      }
    }

    async function addLocation() {
      const form = document.getElementById('addLocationForm');
      const fd = new FormData(form);
      const res = await fetch('/admin/locations/add', { method: 'POST', body: fd });
      const j = await res.json();
      if (j.ok) {
        alert('Lokasyon eklendi. QR dosyası oluşturuldu.');
        form.reset();
        fetchLocations();
      } else {
        alert('Hata: ' + (j.error || 'Bilinmeyen'));
      }
    }

    async function deleteLocation(code) {
      if (!confirm('Bu lokasyonu silmek istediğinizden emin misiniz? (Bu işlem geri alınamaz)')) return;
      const fd = new FormData();
      fd.append('code', code);
      const res = await fetch('/admin/locations/delete', { method: 'POST', body: fd });
      const j = await res.json();
      if (j.ok) {
        alert('Silindi');
        fetchLocations();
        fetchList();
      } else {
        alert('Hata: ' + (j.error || 'Bilinmeyen'));
      }
    }

    /* init */
    fetchList();
    fetchLocations();
    setInterval(fetchList, 3000);
    setInterval(fetchLocations, 8000);
  </script>
</body>

</html>