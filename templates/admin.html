<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Admin Panel - Geri Bildirimler</title>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1"
  >
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    body {
      background: #f3f6fb;
    }

    .badge-issue {
      background: #0d6efd;
      color: white;
      margin-right: 6px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a
        class="navbar-brand"
        href="#"
      >Temizlik Bildirimleri</a>
      <div class="ms-auto">
        <form
          id="logoutForm"
          method="post"
          action="/admin/logout"
        >
          <button
            class="btn btn-outline-secondary btn-sm"
            type="submit"
          >Çıkış</button>
        </form>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div class="row">
      <div class="col-12">
        <h4>Çözülmemiş Bildirimler</h4>
        <p class="text-muted">Yeni bildirimler otomatik olarak listelenir.</p>

        <div id="listbox"></div>
      </div>
    </div>
  </div>

  <script>
    async function fetchList() {
      try {
        const r = await fetch('/api/unresolved');
        const items = await r.json();
        const cont = document.getElementById('listbox');
        if (!items || items.length === 0) {
          cont.innerHTML = '<div class="alert alert-success">Yeni bildirim yok.</div>';
          return;
        }
        let html = '';
        for (const it of items) {
          // issues array
          const issues = it.meta && it.meta.issues ? it.meta.issues : [];
          const note = it.meta && it.meta.note ? it.meta.note : '';
          let issueHtml = '';
          for (const iss of issues) {
            issueHtml += `<span class="badge badge-issue p-2 mb-1" style="background:#0d6efd;color:#fff;margin-right:6px;">${iss.label}</span>`;
          }
          html += `<div class="card mb-2 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title mb-1">${it.name} <small class="text-muted">(${it.code})</small></h6>
              <div class="mb-2">${issueHtml}</div>
              ${note ? `<div class="small text-muted mb-2">Not: ${note}</div>` : ''}
              <div class="small text-muted">Gönderim: ${it.reported_at}</div>
            </div>
            <div class="text-end">
              <button class="btn btn-success btn-sm" onclick="resolve(${it.id})">Tamamlandı</button>
            </div>
          </div>
        </div>
      </div>`;
        }
        cont.innerHTML = html;
      } catch (e) {
        document.getElementById('listbox').innerText = 'Liste alınamadı: ' + e;
      }
    }

    async function resolve(id) {
      const fd = new FormData();
      fd.append('feedback_id', id);
      await fetch('/admin/resolve', { method: 'POST', body: fd });
      fetchList();
    }

    fetchList();
    setInterval(fetchList, 3000);
  </script>
</body>

</html>














<!-- ******** ONCEKI KOD ******** 

<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Admin Panel - Geri Bildirimler</title>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1"
  >
</head>

<body style="font-family: Arial; padding:20px;">
  <h3>Gelen Bildirimler (çözülmemiş)</h3>
  <div>
    <button onclick="logout()">Çıkış</button>
  </div>
  <div
    id="list"
    style="margin-top:12px;"
  ></div>

  <script>
    async function fetchList() {
      try {
        const r = await fetch('/api/unresolved');
        const items = await r.json();
        const cont = document.getElementById('list');
        if (items.length === 0) {
          cont.innerHTML = '<p>Yeni bildirim yok.</p>';
          return;
        }
        let html = '<ul>';
        for (const it of items) {
          html += `<li style="margin-bottom:10px;padding:8px;border:1px solid #ddd;">
        <strong>${it.name}</strong> (<em>${it.code}</em>) — <b>${it.status}</b>
        <div style="font-size:12px;color:#666">Gönderim: ${it.reported_at}</div>
        <div style="margin-top:6px;">
          <button onclick="resolve(${it.id})">Tamamlandı</button>
        </div>
      </li>`;
        }
        html += '</ul>';
        cont.innerHTML = html;
      } catch (e) {
        document.getElementById('list').innerText = 'Liste alınamadı: ' + e;
      }
    }

    async function resolve(id) {
      const fd = new FormData();
      fd.append('feedback_id', id);
      await fetch('/admin/resolve', { method: 'POST', body: fd });
      fetchList();
    }

    function logout() {
      fetch('/admin/logout', { method: 'POST' }).then(() => location.reload());
    }

    // Polling: her 3 saniyede bir listeyi yenile
    fetchList();
    setInterval(fetchList, 3000);
  </script>
</body>

</html> -->