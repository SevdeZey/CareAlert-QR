<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Personel Panel</title>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1"
  >
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    .badge-issue {
      background: #0b69ff;
      color: white;
      padding: 6px;
      border-radius: 8px;
      margin-right: 6px
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-light bg-white shadow-sm">
    <div class="container">
      <a
        class="navbar-brand"
        href="#"
      >Personel - Sorumlu AlanlarÄ±nÄ±z</a>
      <form
        method="post"
        action="/staff/logout"
      ><button class="btn btn-outline-secondary btn-sm">Ã‡Ä±kÄ±ÅŸ</button></form>
    </div>
  </nav>

  <div class="container my-4">
    <h5>Size gelen bildirimler</h5>
    <div id="listbox"></div>
  </div>

  <script>
    async function fetchList() {
      try {
        const r = await fetch('/staff/api/unresolved');
        const items = await r.json();
        const cont = document.getElementById('listbox');
        if (!items || items.length === 0) { cont.innerHTML = '<div class="alert alert-success">Size atanmÄ±ÅŸ yeni bildirim yok.</div>'; return; }
        let html = '';
        for (const it of items) {
          const issues = it.meta && it.meta.issues ? it.meta.issues : [];
          const note = it.meta && it.meta.note ? it.meta.note : '';
          let issueHtml = '';
          for (const iss of issues) { issueHtml += `<span class="badge-issue">${iss.label}</span>`; }
          html += `<div class="card mb-2"><div class="card-body d-flex justify-content-between">
        <div>
          <h6>${it.name} <small class="text-muted">(${it.code})</small></h6>
          <div>${issueHtml}</div>
          ${note ? `<div class="text-muted">Not: ${note}</div>` : ''}
          <div class="text-muted">GÃ¶nderim: ${it.reported_at}</div>
        </div>
        <div><button class="btn btn-success" onclick="resolve(${it.id})">TamamlandÄ±</button></div>
      </div></div>`;
        }
        cont.innerHTML = html;
      } catch (e) { document.getElementById('listbox').innerText = 'Hata: ' + e; }
    }

    // async function resolve(id) {
    //   const fd = new FormData();
    //   fd.append('feedback_id', id);
    //   await fetch('/admin/resolve', { method: 'POST', body: fd });
    //   fetchList();
    // }

    // ðŸ”¹ GÃ¼ncellenmiÅŸ resolve() fonksiyonu
    async function resolve(id) {
      try {
        const fd = new FormData();
        fd.append('feedback_id', id);

        const resp = await fetch('/staff/resolve', { method: 'POST', body: fd });
        const j = await resp.json();

        if (resp.ok && j.ok) {
          // BaÅŸarÄ±lÄ± â€” listeyi yenile veya kaldÄ±r
          fetchList();
        } else {
          alert('Hata: ' + (j.error || resp.statusText || 'Bilinmeyen'));
        }
      } catch (e) {
        alert('AÄŸ hatasÄ±: ' + e.message);
      }
    }

    fetchList();
    setInterval(fetchList, 3000);
  </script>
</body>

</html>